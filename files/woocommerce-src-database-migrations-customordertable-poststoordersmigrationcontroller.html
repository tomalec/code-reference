<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1692866952">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1692866952">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/woocommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/woocommerce-admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/automattic-woocommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-Classes.html"><abbr title="\WooCommerce\Classes">Classes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Abstracts.html"><abbr title="\WooCommerce\Abstracts">Abstracts</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Helper.html"><abbr title="\WooCommerce\Helper">Helper</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Views.html"><abbr title="\WooCommerce\Views">Views</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Templates.html"><abbr title="\WooCommerce\Templates">Templates</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Reports.html"><abbr title="\WooCommerce\Reports">Reports</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Blocks.html"><abbr title="\WooCommerce\Blocks">Blocks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-RestApi.html"><abbr title="\WooCommerce\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-CLI.html"><abbr title="\WooCommerce\CLI">CLI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-l10n.html"><abbr title="\WooCommerce\l10n">l10n</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Webhooks.html"><abbr title="\WooCommerce\Webhooks">Webhooks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-DataStores.html"><abbr title="\WooCommerce\DataStores">DataStores</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Emails.html"><abbr title="\WooCommerce\Emails">Emails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Export.html"><abbr title="\WooCommerce\Export">Export</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Gateways.html"><abbr title="\WooCommerce\Gateways">Gateways</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PayPal.html"><abbr title="\WooCommerce\PayPal">PayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Import.html"><abbr title="\WooCommerce\Import">Import</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Integrations.html"><abbr title="\WooCommerce\Integrations">Integrations</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interfaces.html"><abbr title="\WooCommerce\Interfaces">Interfaces</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interface.html"><abbr title="\WooCommerce\Interface">Interface</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-LogHandlers.html"><abbr title="\WooCommerce\LogHandlers">LogHandlers</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PaymentTokens.html"><abbr title="\WooCommerce\PaymentTokens">PaymentTokens</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Utilities.html"><abbr title="\WooCommerce\Utilities">Utilities</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shipping.html"><abbr title="\WooCommerce\Shipping">Shipping</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shortcodes.html"><abbr title="\WooCommerce\Shortcodes">Shortcodes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Tracks.html"><abbr title="\WooCommerce\Tracks">Tracks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Traits.html"><abbr title="\WooCommerce\Traits">Traits</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Functions.html"><abbr title="\WooCommerce\Functions">Functions</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCom.html"><abbr title="\WooCommerce\WCCom">WCCom</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCOM.html"><abbr title="\WooCommerce\WCCOM">WCCOM</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Widgets.html"><abbr title="\WooCommerce\Widgets">Widgets</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Uninstaller.html"><abbr title="\WooCommerce\Uninstaller">Uninstaller</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceAdmin.html"><abbr title="\WoocommerceAdmin">WoocommerceAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceNavigation.html"><abbr title="\WoocommerceNavigation">WoocommerceNavigation</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/Automattic-WooCommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">PostsToOrdersMigrationController.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Class for implementing migration from wp_posts and wp_postmeta to custom order tables.
 */

namespace Automattic\WooCommerce\Database\Migrations\CustomOrderTable;

use Automattic\WooCommerce\Internal\DataStores\Orders\CustomOrdersTableController;
use Automattic\WooCommerce\Utilities\ArrayUtil;

/**
 * This is the main class used to perform the complete migration of orders
 * from the posts table to the custom orders table.
 *
 * @package Automattic\WooCommerce\Database\Migrations\CustomOrderTable
 */
class PostsToOrdersMigrationController {

	/**
	 * Error logger for migration errors.
	 *
	 * @var \WC_Logger
	 */
	private $error_logger;

	/**
	 * Array of objects used to perform the migration.
	 *
	 * @var TableMigrator[]
	 */
	private $all_migrators;

	/**
	 * The source name to use for logs.
	 */
	public const LOGS_SOURCE_NAME = &#039;posts-to-orders-migration&#039;;

	/**
	 * PostsToOrdersMigrationController constructor.
	 */
	public function __construct() {

		$this-&gt;all_migrators                           = array();
		$this-&gt;all_migrators[&#039;order&#039;]                  = new PostToOrderTableMigrator();
		$this-&gt;all_migrators[&#039;order_address_billing&#039;]  = new PostToOrderAddressTableMigrator( &#039;billing&#039; );
		$this-&gt;all_migrators[&#039;order_address_shipping&#039;] = new PostToOrderAddressTableMigrator( &#039;shipping&#039; );
		$this-&gt;all_migrators[&#039;order_operational_data&#039;] = new PostToOrderOpTableMigrator();
		$this-&gt;all_migrators[&#039;order_meta&#039;]             = new PostMetaToOrderMetaMigrator( $this-&gt;get_migrated_meta_keys() );
		$this-&gt;error_logger                            = wc_get_logger();
	}

	/**
	 * Helper method to get migrated keys for all the tables in this controller.
	 *
	 * @return string[] Array of meta keys.
	 */
	public function get_migrated_meta_keys() {
		$migrated_meta_keys = array();
		foreach ( $this-&gt;all_migrators as $name =&gt; $migrator ) {
			if ( method_exists( $migrator, &#039;get_meta_column_config&#039; ) ) {
				$migrated_meta_keys = array_merge( $migrated_meta_keys, $migrator-&gt;get_meta_column_config() );
			}
		}
		return array_keys( $migrated_meta_keys );
	}

	/**
	 * Migrates a set of orders from the posts table to the custom orders tables.
	 *
	 * @param array $order_post_ids List of post IDs of the orders to migrate.
	 */
	public function migrate_orders( array $order_post_ids ): void {
		$this-&gt;error_logger = WC()-&gt;call_function( &#039;wc_get_logger&#039; );

		$data = array();
		try {
			foreach ( $this-&gt;all_migrators as $name =&gt; $migrator ) {
				$data[ $name ] = $migrator-&gt;fetch_sanitized_migration_data( $order_post_ids );
				if ( ! empty( $data[ $name ][&#039;errors&#039;] ) ) {
					$this-&gt;handle_migration_error( $order_post_ids, $data[ $name ][&#039;errors&#039;], null, null, $name );
					return;
				}
			}
		} catch ( \Exception $e ) {
			$this-&gt;handle_migration_error( $order_post_ids, $data, $e, null, &#039;Fetching data&#039; );
			return;
		}

		$using_transactions = $this-&gt;maybe_start_transaction();

		foreach ( $this-&gt;all_migrators as $name =&gt; $migrator ) {
			$results   = $migrator-&gt;process_migration_data( $data[ $name ] );
			$errors    = array_unique( $results[&#039;errors&#039;] );
			$exception = $results[&#039;exception&#039;];

			if ( null === $exception &amp;&amp; empty( $errors ) ) {
				continue;
			}

			$this-&gt;handle_migration_error( $order_post_ids, $errors, $exception, $using_transactions, $name );
			return;
		}

		if ( $using_transactions ) {
			$this-&gt;commit_transaction();
		}

	}

	/**
	 * Log migration errors if any.
	 *
	 * @param array           $order_post_ids List of post IDs of the orders to migrate.
	 * @param array           $errors List of errors to log.
	 * @param \Exception|null $exception Exception to log.
	 * @param bool|null       $using_transactions Whether transactions were used.
	 * @param string          $name Name of the migrator.
	 */
	private function handle_migration_error( array $order_post_ids, array $errors, ?\Exception $exception, ?bool $using_transactions, string $name ) {
		$batch = ArrayUtil::to_ranges_string( $order_post_ids );

		if ( null !== $exception ) {
			$exception_class = get_class( $exception );
			$this-&gt;error_logger-&gt;error(
				&quot;$name: when processing ids $batch: ($exception_class) {$exception-&gt;getMessage()}, {$exception-&gt;getTraceAsString()}&quot;,
				array(
					&#039;source&#039;    =&gt; self::LOGS_SOURCE_NAME,
					&#039;ids&#039;       =&gt; $order_post_ids,
					&#039;exception&#039; =&gt; $exception,
				)
			);
		}

		foreach ( $errors as $error ) {
			$this-&gt;error_logger-&gt;error(
				&quot;$name: when processing ids $batch: $error&quot;,
				array(
					&#039;source&#039; =&gt; self::LOGS_SOURCE_NAME,
					&#039;ids&#039;    =&gt; $order_post_ids,
					&#039;error&#039;  =&gt; $error,
				)
			);
		}

		if ( $using_transactions ) {
			$this-&gt;rollback_transaction();
		}
	}

	/**
	 * Start a database transaction if the configuration mandates so.
	 *
	 * @return bool|null True if transaction started, false if transactions won&#039;t be used, null if transaction failed to start.
	 *
	 * @throws \Exception If the transaction isolation level is invalid.
	 */
	private function maybe_start_transaction(): ?bool {

		$use_transactions = get_option( CustomOrdersTableController::USE_DB_TRANSACTIONS_OPTION, &#039;yes&#039; );
		if ( &#039;yes&#039; !== $use_transactions ) {
			return null;
		}

		$transaction_isolation_level        = get_option( CustomOrdersTableController::DB_TRANSACTIONS_ISOLATION_LEVEL_OPTION, CustomOrdersTableController::DEFAULT_DB_TRANSACTIONS_ISOLATION_LEVEL );
		$valid_transaction_isolation_levels = array( &#039;READ UNCOMMITTED&#039;, &#039;READ COMMITTED&#039;, &#039;REPEATABLE READ&#039;, &#039;SERIALIZABLE&#039; );
		if ( ! in_array( $transaction_isolation_level, $valid_transaction_isolation_levels, true ) ) {
			throw new \Exception( &quot;Invalid database transaction isolation level name $transaction_isolation_level&quot; );
		}

		$set_transaction_isolation_level_command = &quot;SET TRANSACTION ISOLATION LEVEL $transaction_isolation_level&quot;;

		// We suppress errors in transaction isolation level setting because it&#039;s not supported by all DB engines, additionally, this might be executing in context of another transaction with a different isolation level.
		if ( ! $this-&gt;db_query( $set_transaction_isolation_level_command, true ) ) {
			return null;
		}

		return $this-&gt;db_query( &#039;START TRANSACTION&#039; ) ? true : null;
	}

	/**
	 * Commit the current database transaction.
	 *
	 * @return bool True on success, false on error.
	 */
	private function commit_transaction(): bool {
		return $this-&gt;db_query( &#039;COMMIT&#039; );
	}

	/**
	 * Rollback the current database transaction.
	 *
	 * @return bool True on success, false on error.
	 */
	private function rollback_transaction(): bool {
		return $this-&gt;db_query( &#039;ROLLBACK&#039; );
	}

	/**
	 * Execute a database query and log any errors.
	 *
	 * @param string $query          The SQL query to execute.
	 * @param bool   $supress_errors Whether to suppress errors.
	 *
	 * @return bool True if the query succeeded, false if there were errors.
	 */
	private function db_query( string $query, bool $supress_errors = false ): bool {
		$wpdb = WC()-&gt;get_global( &#039;wpdb&#039; );

		try {
			if ( $supress_errors ) {
				$suppress = $wpdb-&gt;suppress_errors( true );
			}
			// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
			$wpdb-&gt;query( $query );
			if ( $supress_errors ) {
				$wpdb-&gt;suppress_errors( $suppress );
			}
		} catch ( \Exception $exception ) {
			$exception_class = get_class( $exception );
			$this-&gt;error_logger-&gt;error(
				&quot;PostsToOrdersMigrationController: when executing $query: ($exception_class) {$exception-&gt;getMessage()}, {$exception-&gt;getTraceAsString()}&quot;,
				array(
					&#039;source&#039;    =&gt; self::LOGS_SOURCE_NAME,
					&#039;exception&#039; =&gt; $exception,
				)
			);
			return false;
		}

		$error = $wpdb-&gt;last_error;
		if ( &#039;&#039; !== $error ) {
			$this-&gt;error_logger-&gt;error(
				&quot;PostsToOrdersMigrationController: when executing $query: $error&quot;,
				array(
					&#039;source&#039; =&gt; self::LOGS_SOURCE_NAME,
					&#039;error&#039;  =&gt; $error,
				)
			);
			return false;
		}

		return true;
	}

	/**
	 * Verify whether the given order IDs were migrated properly or not.
	 *
	 * @param array $order_post_ids Order IDs.
	 *
	 * @return array Array of failed IDs along with columns.
	 */
	public function verify_migrated_orders( array $order_post_ids ): array {
		$errors = array();
		foreach ( $this-&gt;all_migrators as $migrator ) {
			if ( method_exists( $migrator, &#039;verify_migrated_data&#039; ) ) {
				$errors = $errors + $migrator-&gt;verify_migrated_data( $order_post_ids );
			}
		}
		return $errors;
	}

	/**
	 * Migrates an order from the posts table to the custom orders tables.
	 *
	 * @param int $order_post_id Post ID of the order to migrate.
	 */
	public function migrate_order( int $order_post_id ): void {
		$this-&gt;migrate_orders( array( $order_post_id ) );
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on August 24th, 2023 at 08:49 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1692866952"></script>
    <script src="../js/search.js?updated=1692866952"></script>
</body>
</html>
