<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1692866952">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1692866952">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/woocommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/woocommerce-admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/automattic-woocommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-Classes.html"><abbr title="\WooCommerce\Classes">Classes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Abstracts.html"><abbr title="\WooCommerce\Abstracts">Abstracts</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Helper.html"><abbr title="\WooCommerce\Helper">Helper</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Views.html"><abbr title="\WooCommerce\Views">Views</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Templates.html"><abbr title="\WooCommerce\Templates">Templates</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Reports.html"><abbr title="\WooCommerce\Reports">Reports</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Blocks.html"><abbr title="\WooCommerce\Blocks">Blocks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-RestApi.html"><abbr title="\WooCommerce\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-CLI.html"><abbr title="\WooCommerce\CLI">CLI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-l10n.html"><abbr title="\WooCommerce\l10n">l10n</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Webhooks.html"><abbr title="\WooCommerce\Webhooks">Webhooks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-DataStores.html"><abbr title="\WooCommerce\DataStores">DataStores</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Emails.html"><abbr title="\WooCommerce\Emails">Emails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Export.html"><abbr title="\WooCommerce\Export">Export</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Gateways.html"><abbr title="\WooCommerce\Gateways">Gateways</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PayPal.html"><abbr title="\WooCommerce\PayPal">PayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Import.html"><abbr title="\WooCommerce\Import">Import</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Integrations.html"><abbr title="\WooCommerce\Integrations">Integrations</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interfaces.html"><abbr title="\WooCommerce\Interfaces">Interfaces</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interface.html"><abbr title="\WooCommerce\Interface">Interface</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-LogHandlers.html"><abbr title="\WooCommerce\LogHandlers">LogHandlers</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PaymentTokens.html"><abbr title="\WooCommerce\PaymentTokens">PaymentTokens</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Utilities.html"><abbr title="\WooCommerce\Utilities">Utilities</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shipping.html"><abbr title="\WooCommerce\Shipping">Shipping</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shortcodes.html"><abbr title="\WooCommerce\Shortcodes">Shortcodes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Tracks.html"><abbr title="\WooCommerce\Tracks">Tracks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Traits.html"><abbr title="\WooCommerce\Traits">Traits</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Functions.html"><abbr title="\WooCommerce\Functions">Functions</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCom.html"><abbr title="\WooCommerce\WCCom">WCCom</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCOM.html"><abbr title="\WooCommerce\WCCOM">WCCOM</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Widgets.html"><abbr title="\WooCommerce\Widgets">Widgets</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Uninstaller.html"><abbr title="\WooCommerce\Uninstaller">Uninstaller</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceAdmin.html"><abbr title="\WoocommerceAdmin">WoocommerceAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceNavigation.html"><abbr title="\WoocommerceNavigation">WoocommerceNavigation</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/Automattic-WooCommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">CLIRunner.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php

namespace Automattic\WooCommerce\DataBase\Migrations\CustomOrderTable;

use Automattic\WooCommerce\Internal\DataStores\Orders\CustomOrdersTableController;
use Automattic\WooCommerce\Internal\DataStores\Orders\DataSynchronizer;
use Automattic\WooCommerce\Internal\DataStores\Orders\OrdersTableDataStore;
use WP_CLI;

/**
 * CLI tool for migrating order data to/from custom table.
 *
 * Credits https://github.com/liquidweb/woocommerce-custom-orders-table/blob/develop/includes/class-woocommerce-custom-orders-table-cli.php.
 *
 * Class CLIRunner
 */
class CLIRunner {

	/**
	 * CustomOrdersTableController instance.
	 *
	 * @var CustomOrdersTableController
	 */
	private $controller;

	/**
	 * DataSynchronizer instance.
	 *
	 * @var DataSynchronizer;
	 */
	private $synchronizer;

	/**
	 * PostsToOrdersMigrationController instance.
	 *
	 * @var PostsToOrdersMigrationController
	 */
	private $post_to_cot_migrator;

	/**
	 * Init method, invoked by DI container.
	 *
	 * @param CustomOrdersTableController      $controller Instance.
	 * @param DataSynchronizer                 $synchronizer Instance.
	 * @param PostsToOrdersMigrationController $posts_to_orders_migration_controller Instance.
	 *
	 * @internal
	 */
	final public function init( CustomOrdersTableController $controller, DataSynchronizer $synchronizer, PostsToOrdersMigrationController $posts_to_orders_migration_controller ) {
		$this-&gt;controller           = $controller;
		$this-&gt;synchronizer         = $synchronizer;
		$this-&gt;post_to_cot_migrator = $posts_to_orders_migration_controller;
	}

	/**
	 * Registers commands for CLI.
	 */
	public function register_commands() {
		WP_CLI::add_command( &#039;wc cot count_unmigrated&#039;, array( $this, &#039;count_unmigrated&#039; ) );
		WP_CLI::add_command( &#039;wc cot migrate&#039;, array( $this, &#039;migrate&#039; ) );
		WP_CLI::add_command( &#039;wc cot sync&#039;, array( $this, &#039;sync&#039; ) );
		WP_CLI::add_command( &#039;wc cot verify_cot_data&#039;, array( $this, &#039;verify_cot_data&#039; ) );
	}

	/**
	 * Check if the COT feature is enabled.
	 *
	 * @param bool $log Optionally log a error message.
	 *
	 * @return bool Whether the COT feature is enabled.
	 */
	private function is_enabled( $log = true ) : bool {
		if ( ! $this-&gt;controller-&gt;is_feature_visible() ) {
			if ( $log ) {
				WP_CLI::log(
					sprintf(
						// translators: %s - link to testing instructions webpage.
						__( &#039;Custom order table usage is not enabled. If you are testing, you can enable it by following the testing instructions in %s&#039;, &#039;woocommerce&#039; ),
						&#039;https://github.com/woocommerce/woocommerce/wiki/High-Performance-Order-Storage-Upgrade-Recipe-Book&#039;
					)
				);
			}
		}

		return $this-&gt;controller-&gt;is_feature_visible();
	}

	/**
	 * Helper method to log warning that feature is not yet production ready.
	 */
	private function log_production_warning() {
		WP_CLI::log( __( &#039;This feature is not production ready yet. Make sure you are not running these commands in your production environment.&#039;, &#039;woocommerce&#039; ) );
	}

	/**
	 * Count how many orders have yet to be migrated into the custom orders table.
	 *
	 * ## EXAMPLES
	 *
	 *     wp wc cot count_unmigrated
	 *
	 * @param array $args Positional arguments passed to the command.
	 *
	 * @param array $assoc_args Associative arguments (options) passed to the command.
	 *
	 * @return int The number of orders to be migrated.*
	 */
	public function count_unmigrated( $args = array(), $assoc_args = array() ) : int {
		if ( ! $this-&gt;is_enabled() ) {
			return 0;
		}

		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
		$order_count = $this-&gt;synchronizer-&gt;get_current_orders_pending_sync_count();

		$assoc_args = wp_parse_args(
			$assoc_args,
			array(
				&#039;log&#039; =&gt; true,
			)
		);
		if ( isset( $assoc_args[&#039;log&#039;] ) &amp;&amp; $assoc_args[&#039;log&#039;] ) {
			WP_CLI::log(
				sprintf(
					/* Translators: %1$d is the number of orders to be synced. */
					_n(
						&#039;There is %1$d order to be synced.&#039;,
						&#039;There are %1$d orders to be synced.&#039;,
						$order_count,
						&#039;woocommerce&#039;
					),
					$order_count
				)
			);
		}

		return (int) $order_count;
	}

	/**
	 * Sync order data between the custom order tables and the core WordPress post tables.
	 *
	 * ## OPTIONS
	 *
	 * [--batch-size=&lt;batch-size&gt;]
	 * : The number of orders to process in each batch.
	 * ---
	 * default: 500
	 * ---
	 *
	 * ## EXAMPLES
	 *
	 *     wp wc cot sync --batch-size=500
	 *
	 * @param array $args Positional arguments passed to the command.
	 * @param array $assoc_args Associative arguments (options) passed to the command.
	 */
	public function sync( $args = array(), $assoc_args = array() ) {
		$this-&gt;log_production_warning();
		if ( ! $this-&gt;is_enabled() ) {
			return;
		}

		$order_count = $this-&gt;count_unmigrated();

		// Abort if there are no orders to migrate.
		if ( ! $order_count ) {
			return WP_CLI::warning( __( &#039;There are no orders to sync, aborting.&#039;, &#039;woocommerce&#039; ) );
		}

		$assoc_args       = wp_parse_args(
			$assoc_args,
			array(
				&#039;batch-size&#039; =&gt; 500,
			)
		);
		$batch_size       = ( (int) $assoc_args[&#039;batch-size&#039;] ) === 0 ? 500 : (int) $assoc_args[&#039;batch-size&#039;];
		$progress         = WP_CLI\Utils\make_progress_bar( &#039;Order Data Sync&#039;, $order_count / $batch_size );
		$processed        = 0;
		$batch_count      = 1;
		$total_time       = 0;
		$orders_remaining = true;

		while ( $order_count &gt; 0 || $orders_remaining ) {
			$remaining_count = $order_count;

			WP_CLI::debug(
				sprintf(
					/* Translators: %1$d is the batch number and %2$d is the batch size. */
					__( &#039;Beginning batch #%1$d (%2$d orders/batch).&#039;, &#039;woocommerce&#039; ),
					$batch_count,
					$batch_size
				)
			);
			$batch_start_time = microtime( true );
			$order_ids        = $this-&gt;synchronizer-&gt;get_next_batch_to_process( $batch_size );
			if ( count( $order_ids ) ) {
				$this-&gt;synchronizer-&gt;process_batch( $order_ids );
			}
			$processed       += count( $order_ids );
			$batch_total_time = microtime( true ) - $batch_start_time;

			WP_CLI::debug(
				sprintf(
					// Translators: %1$d is the batch number, %2$d is the number of processed orders and %3$d is the execution time in seconds.
					__( &#039;Batch %1$d (%2$d orders) completed in %3$d seconds&#039;, &#039;woocommerce&#039; ),
					$batch_count,
					count( $order_ids ),
					$batch_total_time
				)
			);

			$batch_count ++;
			$total_time += $batch_total_time;

			$progress-&gt;tick();

			$orders_remaining = count( $this-&gt;synchronizer-&gt;get_next_batch_to_process( 1 ) ) &gt; 0;
			$order_count      = $remaining_count - $batch_size;
		}

		$progress-&gt;finish();

		// Issue a warning if no orders were migrated.
		if ( ! $processed ) {
			return WP_CLI::warning( __( &#039;No orders were synced.&#039;, &#039;woocommerce&#039; ) );
		}

		WP_CLI::log( __( &#039;Sync completed.&#039;, &#039;woocommerce&#039; ) );

		return WP_CLI::success(
			sprintf(
				/* Translators: %1$d is the number of migrated orders and %2$d is the execution time in seconds. */
				_n(
					&#039;%1$d order was synced in %2$d seconds.&#039;,
					&#039;%1$d orders were synced in %2$d seconds.&#039;,
					$processed,
					&#039;woocommerce&#039;
				),
				$processed,
				$total_time
			)
		);
	}

	/**
	 * Copy order data into the postmeta table.
	 *
	 * Note that this could dramatically increase the size of your postmeta table, but is recommended
	 * if you wish to stop using the custom orders table plugin.
	 *
	 * ## OPTIONS
	 *
	 * [--batch-size=&lt;batch-size&gt;]
	 * : The number of orders to process in each batch. Passing a value of 0 will disable batching.
	 * ---
	 * default: 500
	 * ---
	 *
	 * ## EXAMPLES
	 *
	 *     # Copy all order data into the post meta table, 500 posts at a time.
	 *     wp wc cot backfill --batch-size=500
	 *
	 * @param array $args Positional arguments passed to the command.
	 * @param array $assoc_args Associative arguments (options) passed to the command.
	 */
	public function migrate( $args = array(), $assoc_args = array() ) {
		$this-&gt;log_production_warning();
		WP_CLI::log( __( &#039;Migrate command is deprecated. Please use `sync` instead.&#039;, &#039;woocommerce&#039; ) );
	}

	/**
	 * Verify migrated order data with original posts data.
	 *
	 * ## OPTIONS
	 *
	 * [--batch-size=&lt;batch-size&gt;]
	 * : The number of orders to verify in each batch.
	 * ---
	 * default: 500
	 * ---
	 *
	 * [--start-from=&lt;order_id&gt;]
	 * : Order ID to start from.
	 * ---
	 * default: 0
	 * ---
	 *
	 * [--end-at=&lt;order_id&gt;]
	 * : Order ID to end at.
	 * ---
	 * default: -1
	 * ---
	 *
	 * [--verbose]
	 * : Whether to output errors as they happen in batch, or output them all together at the end.
	 * ---
	 * default: false
	 * ---
	 *
	 * [--order-types]
	 * : Comma seperated list of order types that needs to be verified. For example, --order-types=shop_order,shop_order_refund
	 * ---
	 * default: Output of function `wc_get_order_types( &#039;cot-migration&#039; )`
	 *
	 * [--re-migrate]
	 * : Attempt to re-migrate orders that failed verification. You should only use this option when you have never run the site with HPOS as authoritative source of order data yet, or you have manually checked the reported errors, otherwise, you risk stale data overwriting the more recent data.
	 * This option can only be enabled when --verbose flag is also set.
	 * default: false
	 *
	 * ## EXAMPLES
	 *
	 *     # Verify migrated order data, 500 orders at a time.
	 *     wp wc cot verify_cot_data --batch-size=500 --start-from=0 --end-at=10000
	 *
	 * @param array $args Positional arguments passed to the command.
	 * @param array $assoc_args Associative arguments (options) passed to the command.
	 */
	public function verify_cot_data( $args = array(), $assoc_args = array() ) {
		global $wpdb;
		$this-&gt;log_production_warning();
		if ( ! $this-&gt;is_enabled() ) {
			return;
		}

		$assoc_args = wp_parse_args(
			$assoc_args,
			array(
				&#039;batch-size&#039;  =&gt; 500,
				&#039;start-from&#039;  =&gt; 0,
				&#039;end-at&#039;      =&gt; - 1,
				&#039;verbose&#039;     =&gt; false,
				&#039;order-types&#039; =&gt; &#039;&#039;,
				&#039;re-migrate&#039;  =&gt; false,
			)
		);

		$batch_count    = 1;
		$total_time     = 0;
		$failed_ids     = array();
		$processed      = 0;
		$order_id_start = (int) $assoc_args[&#039;start-from&#039;];
		$order_id_end   = (int) $assoc_args[&#039;end-at&#039;];
		$order_id_end   = -1 === $order_id_end ? PHP_INT_MAX : $order_id_end;
		$batch_size     = ( (int) $assoc_args[&#039;batch-size&#039;] ) === 0 ? 500 : (int) $assoc_args[&#039;batch-size&#039;];
		$verbose        = (bool) $assoc_args[&#039;verbose&#039;];
		$order_types    = wc_get_order_types( &#039;cot-migration&#039; );
		$remigrate      = (bool) $assoc_args[&#039;re-migrate&#039;];
		if ( ! empty( $assoc_args[&#039;order-types&#039;] ) ) {
			$passed_order_types = array_map( &#039;trim&#039;, explode( &#039;,&#039;, $assoc_args[&#039;order-types&#039;] ) );
			$order_types        = array_intersect( $order_types, $passed_order_types );
		}

		if ( 0 === count( $order_types ) ) {
			return WP_CLI::error(
				sprintf(
				/* Translators: %s is the comma seperated list of order types. */
					__( &#039;Passed order type does not match any registered order types. Following order types are registered: %s&#039;, &#039;woocommerce&#039; ),
					implode( &#039;,&#039;, wc_get_order_types( &#039;cot-migration&#039; ) )
				)
			);
		}

		$order_types_pl = implode( &#039;,&#039;, array_fill( 0, count( $order_types ), &#039;%s&#039; ) );

		$order_count = $this-&gt;get_verify_order_count( $order_id_start, $order_id_end, $order_types, false );

		$progress = WP_CLI\Utils\make_progress_bar( &#039;Order Data Verification&#039;, $order_count / $batch_size );

		if ( ! $order_count ) {
			return WP_CLI::warning( __( &#039;There are no orders to verify, aborting.&#039;, &#039;woocommerce&#039; ) );
		}

		while ( $order_count &gt; 0 ) {
			WP_CLI::debug(
				sprintf(
					/* Translators: %1$d is the batch number, %2$d is the batch size. */
					__( &#039;Beginning verification for batch #%1$d (%2$d orders/batch).&#039;, &#039;woocommerce&#039; ),
					$batch_count,
					$batch_size
				)
			);

			// phpcs:disable WordPress.DB.PreparedSQLPlaceholders.ReplacementsWrongNumber, WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Inputs are prepared.
			$order_ids = $wpdb-&gt;get_col(
				$wpdb-&gt;prepare(
					&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_type in ( $order_types_pl ) AND ID &gt;= %d AND ID &lt;= %d ORDER BY ID ASC LIMIT %d&quot;,
					array_merge(
						$order_types,
						array(
							$order_id_start,
							$order_id_end,
							$batch_size,
						)
					)
				)
			);
			// phpcs:enable
			$batch_start_time            = microtime( true );
			$failed_ids_in_current_batch = $this-&gt;post_to_cot_migrator-&gt;verify_migrated_orders( $order_ids );
			$failed_ids_in_current_batch = $this-&gt;verify_meta_data( $order_ids, $failed_ids_in_current_batch );
			$failed_ids                  = $verbose ? array() : $failed_ids + $failed_ids_in_current_batch;
			$processed                  += count( $order_ids );
			$batch_total_time            = microtime( true ) - $batch_start_time;
			$batch_count ++;
			$total_time += $batch_total_time;

			if ( $verbose &amp;&amp; count( $failed_ids_in_current_batch ) &gt; 0 ) {
				$errors = wp_json_encode( $failed_ids_in_current_batch, JSON_PRETTY_PRINT );
				WP_CLI::warning(
					sprintf(
					/* Translators: %1$d is number of errors and %2$s is the formatted array of order IDs. */
						_n(
							&#039;%1$d error found: %2$s. Please review the error above.&#039;,
							&#039;%1$d errors found: %2$s. Please review the errors above.&#039;,
							count( $failed_ids_in_current_batch ),
							&#039;woocommerce&#039;
						),
						count( $failed_ids_in_current_batch ),
						$errors
					)
				);
				if ( $remigrate ) {
					WP_CLI::warning(
						sprintf(
							__( &#039;Attempting to remigrate...&#039;, &#039;woocommerce&#039; )
						)
					);
					$failed_ids = array_keys( $failed_ids_in_current_batch );
					$this-&gt;synchronizer-&gt;process_batch( $failed_ids );
					$errors_in_remigrate_batch = $this-&gt;post_to_cot_migrator-&gt;verify_migrated_orders( $failed_ids );
					$errors_in_remigrate_batch = $this-&gt;verify_meta_data( $failed_ids, $errors_in_remigrate_batch );
					if ( count( $errors_in_remigrate_batch ) &gt; 0 ) {
						$formatted_errors = wp_json_encode( $errors_in_remigrate_batch, JSON_PRETTY_PRINT );
						WP_CLI::warning(
							sprintf(
							/* Translators: %1$d is number of errors and %2$s is the formatted array of order IDs. */
								_n(
									&#039;%1$d error found: %2$s when re-migrating order. Please review the error above.&#039;,
									&#039;%1$d errors found: %2$s when re-migrating orders. Please review the errors above.&#039;,
									count( $errors_in_remigrate_batch ),
									&#039;woocommerce&#039;
								),
								count( $errors_in_remigrate_batch ),
								$formatted_errors
							)
						);
					} else {
						WP_CLI::warning( &#039;Re-migration successful.&#039;, &#039;woocommerce&#039; );
					}
				}
			}

			$progress-&gt;tick();

			WP_CLI::debug(
				sprintf(
					/* Translators: %1$d is the batch number, %2$d is time taken to process batch. */
					__( &#039;Batch %1$d (%2$d orders) completed in %3$d seconds.&#039;, &#039;woocommerce&#039; ),
					$batch_count,
					count( $order_ids ),
					$batch_total_time
				)
			);

			$order_id_start  = max( $order_ids ) + 1;
			$remaining_count = $this-&gt;get_verify_order_count( $order_id_start, $order_id_end, $order_types, false );
			if ( $remaining_count === $order_count ) {
				return WP_CLI::error( __( &#039;Infinite loop detected, aborting. No errors found.&#039;, &#039;woocommerce&#039; ) );
			}
			$order_count = $remaining_count;
		}

		$progress-&gt;finish();
		WP_CLI::log( __( &#039;Verification completed.&#039;, &#039;woocommerce&#039; ) );

		if ( $verbose ) {
			return;
		}

		if ( 0 === count( $failed_ids ) ) {
			return WP_CLI::success(
				sprintf(
					/* Translators: %1$d is the number of migrated orders and %2$d is time taken. */
					_n(
						&#039;%1$d order was verified in %2$d seconds.&#039;,
						&#039;%1$d orders were verified in %2$d seconds.&#039;,
						$processed,
						&#039;woocommerce&#039;
					),
					$processed,
					$total_time
				)
			);
		} else {
			$errors = wp_json_encode( $failed_ids, JSON_PRETTY_PRINT );

			return WP_CLI::error(
				sprintf(
					&#039;%1$s %2$s&#039;,
					sprintf(
						/* Translators: %1$d is the number of migrated orders and %2$d is the execution time in seconds. */
						_n(
							&#039;%1$d order was verified in %2$d seconds.&#039;,
							&#039;%1$d orders were verified in %2$d seconds.&#039;,
							$processed,
							&#039;woocommerce&#039;
						),
						$processed,
						$total_time
					),
					sprintf(
						/* Translators: %1$d is number of errors and %2$s is the formatted array of order IDs. */
						_n(
							&#039;%1$d error found: %2$s. Please review the error above.&#039;,
							&#039;%1$d errors found: %2$s. Please review the errors above.&#039;,
							count( $failed_ids ),
							&#039;woocommerce&#039;
						),
						count( $failed_ids ),
						$errors
					)
				)
			);
		}
	}

	/**
	 * Helper method to get count for orders needing verification.
	 *
	 * @param int   $order_id_start Order ID to start from.
	 * @param int   $order_id_end Order ID to end at.
	 * @param array $order_types List of order types to verify.
	 * @param bool  $log Whether to also log an error message.
	 *
	 * @return int Order count.
	 */
	private function get_verify_order_count( int $order_id_start, int $order_id_end, array $order_types, bool $log = true ) : int {
		global $wpdb;

		$order_types_placeholder = implode( &#039;,&#039;, array_fill( 0, count( $order_types ), &#039;%s&#039; ) );

		// phpcs:disable WordPress.DB.PreparedSQLPlaceholders.ReplacementsWrongNumber, WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Inputs are prepared.
		$order_count = (int) $wpdb-&gt;get_var(
			$wpdb-&gt;prepare(
				&quot;SELECT COUNT(*) FROM $wpdb-&gt;posts WHERE post_type in ($order_types_placeholder) AND ID &gt;= %d AND ID &lt;= %d&quot;,
				array_merge(
					$order_types,
					array(
						$order_id_start,
						$order_id_end,
					)
				)
			)
		);
		// phpcs:enable

		if ( $log ) {
			WP_CLI::log(
				sprintf(
					/* Translators: %1$d is the number of orders to be verified. */
					_n(
						&#039;There is %1$d order to be verified.&#039;,
						&#039;There are %1$d orders to be verified.&#039;,
						$order_count,
						&#039;woocommerce&#039;
					),
					$order_count
				)
			);
		}

		return $order_count;
	}

	/**
	 * Verify meta data as part of verifying the order object.
	 *
	 * @param array $order_ids Order IDs.
	 * @param array $failed_ids Array for storing failed IDs.
	 *
	 * @return array Failed IDs with meta details.
	 */
	private function verify_meta_data( array $order_ids, array $failed_ids ) : array {
		global $wpdb;
		if ( ! count( $order_ids ) ) {
			return array();
		}
		$excluded_columns             = $this-&gt;post_to_cot_migrator-&gt;get_migrated_meta_keys();
		$excluded_columns_placeholder = implode( &#039;, &#039;, array_fill( 0, count( $excluded_columns ), &#039;%s&#039; ) );
		$order_ids_placeholder        = implode( &#039;, &#039;, array_fill( 0, count( $order_ids ), &#039;%d&#039; ) );
		$meta_table                   = OrdersTableDataStore::get_meta_table_name();

		// phpcs:disable WordPress.DB.PreparedSQL.InterpolatedNotPrepared, WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQLPlaceholders.UnfinishedPrepare -- table names are hardcoded, orders_ids and excluded_columns are prepared.
		$query       = $wpdb-&gt;prepare(
			&quot;
SELECT {$wpdb-&gt;postmeta}.post_id as entity_id, {$wpdb-&gt;postmeta}.meta_key, {$wpdb-&gt;postmeta}.meta_value
FROM $wpdb-&gt;postmeta
WHERE
      {$wpdb-&gt;postmeta}.post_id in ( $order_ids_placeholder ) AND
      {$wpdb-&gt;postmeta}.meta_key not in ( $excluded_columns_placeholder )
ORDER BY {$wpdb-&gt;postmeta}.post_id ASC, {$wpdb-&gt;postmeta}.meta_key ASC;
&quot;,
			array_merge(
				$order_ids,
				$excluded_columns
			)
		);
		$source_data = $wpdb-&gt;get_results( $query, ARRAY_A );
		// phpcs:enable

		$normalized_source_data = $this-&gt;normalize_raw_meta_data( $source_data );

		// phpcs:disable WordPress.DB.PreparedSQL.InterpolatedNotPrepared, WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQLPlaceholders.UnfinishedPrepare -- table names are hardcoded, orders_ids and excluded_columns are prepared.
		$migrated_query = $wpdb-&gt;prepare(
			&quot;
SELECT $meta_table.order_id as entity_id, $meta_table.meta_key, $meta_table.meta_value
FROM $meta_table
WHERE
	$meta_table.order_id in ( $order_ids_placeholder )
ORDER BY $meta_table.order_id ASC, $meta_table.meta_key ASC;
&quot;,
			$order_ids
		);
		$migrated_data  = $wpdb-&gt;get_results( $migrated_query, ARRAY_A );
		// phpcs:enable

		$normalized_migrated_meta_data = $this-&gt;normalize_raw_meta_data( $migrated_data );

		foreach ( $normalized_source_data as $order_id =&gt; $meta ) {
			foreach ( $meta as $meta_key =&gt; $values ) {
				$migrated_meta_values = isset( $normalized_migrated_meta_data[ $order_id ][ $meta_key ] ) ? $normalized_migrated_meta_data[ $order_id ][ $meta_key ] : array();
				$diff                 = array_diff( $values, $migrated_meta_values );

				if ( count( $diff ) ) {
					if ( ! isset( $failed_ids[ $order_id ] ) ) {
						$failed_ids[ $order_id ] = array();
					}
					$failed_ids[ $order_id ][] = array(
						&#039;order_id&#039;         =&gt; $order_id,
						&#039;meta_key&#039;         =&gt; $meta_key, // phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_key -- Not a meta query.
						&#039;orig_meta_values&#039; =&gt; $values,
						&#039;new_meta_values&#039;  =&gt; $migrated_meta_values,
					);
				}
			}
		}

		return $failed_ids;
	}

	/**
	 * Helper method to normalize response from meta queries into order_id &gt; meta_key &gt; meta_values.
	 *
	 * @param array $data Data fetched from meta queries.
	 *
	 * @return array Normalized data.
	 */
	private function normalize_raw_meta_data( array $data ) : array {
		$clubbed_data = array();
		foreach ( $data as $row ) {
			if ( ! isset( $clubbed_data[ $row[&#039;entity_id&#039;] ] ) ) {
				$clubbed_data[ $row[&#039;entity_id&#039;] ] = array();
			}
			if ( ! isset( $clubbed_data[ $row[&#039;entity_id&#039;] ][ $row[&#039;meta_key&#039;] ] ) ) {
				$clubbed_data[ $row[&#039;entity_id&#039;] ][ $row[&#039;meta_key&#039;] ] = array(); // phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_key -- Not a meta query.
			}
			$clubbed_data[ $row[&#039;entity_id&#039;] ][ $row[&#039;meta_key&#039;] ][] = $row[&#039;meta_value&#039;];
		}
		return $clubbed_data;
	}

}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on August 24th, 2023 at 08:49 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1692866952"></script>
    <script src="../js/search.js?updated=1692866952"></script>
</body>
</html>
